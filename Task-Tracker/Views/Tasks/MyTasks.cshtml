@model IEnumerable<TaskTracker.Models.AppTask>
@{
    ViewData["Title"] = "My Tasks";
    ViewData["ActivePage"] = "My Tasks";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold">My Assigned Tasks</h3>
            <p class="text-muted mb-0">You have @Model.Count(t => t.Status != TaskTracker.Models.AppTaskStatus.Completed) active tasks.</p>
        </div>
    </div>

    <div class="row g-4">
        @foreach (var item in Model)
        {
                int total = item.TodoItems?.Count ?? 0;
                int done = item.TodoItems?.Count(i => i.IsCompleted) ?? 0;
                int percent = total == 0 ? 0 : (int)((double)done / total * 100);

            <div class="col-md-6 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4 d-flex flex-column">

                        <div class="d-flex justify-content-between mb-3">
                            @if (item.Priority == TaskTracker.Models.TaskPriority.High)
                            {
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">High Priority</span>
                            }
                            else if (item.Priority == TaskTracker.Models.TaskPriority.Medium)
                            {
                                <span class="badge bg-warning bg-opacity-10 text-warning border border-warning">Medium</span>
                            }
                            else
                            {
                                <span class="badge bg-success bg-opacity-10 text-success border border-success">Low Priority</span>
                            }
                            <small class="text-muted"><i class="fa-regular fa-clock me-1"></i> Due: @item.DueDate.ToString("MMM dd")</small>
                        </div>

                        <h5 class="fw-bold text-dark mb-2">@item.Title</h5>

                        <div class="mb-3">
                            <span id="status-badge-@item.Id" class="badge @GetStatusClass(item.Status)">
                                @item.Status
                            </span>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between small mb-1">
                                <span class="text-muted fw-bold" style="font-size: 0.8rem;">CHECKLIST</span>
                                <span id="progress-text-@item.Id">@percent%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div id="progress-bar-@item.Id" class="progress-bar bg-primary" style="width: @percent%"></div>
                            </div>
                        </div>

                        <p class="text-muted small mb-3 flex-grow-1 text-truncate">
                            @item.Description
                        </p>

                        <div class="mt-auto pt-3 border-top">
                            <button class="btn btn-outline-primary w-100 fw-bold" data-bs-toggle="modal" data-bs-target="#taskModal-@item.Id">
                                <i class="fa-solid fa-list-check me-2"></i> View & Update
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="modal fade" id="taskModal-@item.Id" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold">@item.Title</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted">@item.Description</p>
                            
                            <h6 class="fw-bold mt-4 mb-3">Checklist</h6>
                            <div class="list-group">
                                @if (item.TodoItems == null || !item.TodoItems.Any())
                                {
                                    <div class="text-center text-muted small p-3 border rounded bg-light">
                                        No checklist items.
                                    </div>
                                }
                                else 
                                {
                                    @foreach (var todo in item.TodoItems)
                                    {
                                        <label class="list-group-item d-flex gap-3 align-items-center" style="cursor: pointer;">
                                            <input class="form-check-input flex-shrink-0" type="checkbox" 
                                                   style="width: 1.3em; height: 1.3em;"
                                                   @(todo.IsCompleted ? "checked" : "")
                                                   onchange="toggleTodo(@todo.Id, @item.Id)">
                                            
                                            <span class="@(todo.IsCompleted ? "text-decoration-line-through text-muted" : "")" id="todo-text-@todo.Id">
                                                @todo.Description
                                            </span>
                                        </label>
                                    }
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(item.AttachmentPath))
                            {
                                <div class="mt-4 pt-3 border-top">
                                    <small class="text-muted fw-bold">ATTACHMENT</small><br/>
                                    <a href="~/attachments/@item.AttachmentPath" target="_blank" class="btn btn-sm btn-light border mt-2">
                                        <i class="fa-solid fa-paperclip me-2"></i> View File
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (!Model.Any())
        {
            <div class="col-12 text-center py-5">
                <div class="text-muted mb-3"><i class="fa-solid fa-mug-hot fa-3x"></i></div>
                <h4 class="fw-bold">All caught up!</h4>
                <p class="text-muted">You have no tasks assigned to you right now.</p>
            </div>
        }
    </div>
</div>

@functions {
    string GetStatusClass(TaskTracker.Models.AppTaskStatus s) => s switch {
        TaskTracker.Models.AppTaskStatus.Completed => "bg-success text-white",
        TaskTracker.Models.AppTaskStatus.InProgress => "bg-info text-dark",
        _ => "bg-secondary text-white"
    };
}

@section Scripts {
    <script>
        function toggleTodo(todoId, taskId) {
            // Call the Controller
            fetch('/Tasks/ToggleTodo/' + todoId, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 1. Update Progress Bar Width & Text
                    document.getElementById('progress-bar-' + taskId).style.width = data.progress + '%';
                    document.getElementById('progress-text-' + taskId).innerText = data.progress + '%';

                    // 2. Update Status Badge Color & Text
                    var badge = document.getElementById('status-badge-' + taskId);
                    badge.innerText = data.status;
                    
                    // Reset classes and apply new ones based on status
                    badge.className = 'badge';
                    if (data.status === 'Completed') badge.classList.add('bg-success', 'text-white');
                    else if (data.status === 'InProgress') badge.classList.add('bg-info', 'text-dark');
                    else badge.classList.add('bg-secondary', 'text-white');

                    // 3. Update Text Strikethrough inside the modal
                    var textElement = document.getElementById('todo-text-' + todoId);
                    
                    if (data.isCompleted) {
                        textElement.classList.add('text-decoration-line-through', 'text-muted');
                    } else {
                        textElement.classList.remove('text-decoration-line-through', 'text-muted');
                    }
                }
            });
        }
    </script>
}